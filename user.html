<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>FZ Network - Chat</title>
  <style>
    * {margin:0;padding:0;box-sizing:border-box;}
    body {font-family:'Segoe UI',Tahoma,sans-serif;background:#fff;height:100vh;height:100dvh;overflow:hidden;}

    /* Header */
    .header {
      background:#fff;padding:12px 16px;border-bottom:1px solid #e5e7eb;
      display:flex;justify-content:space-between;align-items:center;height:60px;z-index:10;
    }
    .header-left {display:flex;align-items:center;gap:10px;}
    .logo-icon {width:36px;height:36px;background:#000;border-radius:8px;color:#fff;
      display:flex;align-items:center;justify-content:center;font-weight:700;font-size:16px;}
    .logo-text {font-size:18px;font-weight:700;color:#111827;}

    .header-right {display:flex;align-items:center;gap:14px;}
    .user-info {display:flex;align-items:center;gap:10px;}
    .user-avatar {width:36px;height:36px;background:#000;border-radius:50%;color:#fff;
      display:flex;align-items:center;justify-content:center;font-weight:600;font-size:14px;}
    .user-name {font-size:14px;color:#111827;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    /* Beautiful Circular Logout Button – Only Icon */
    .logout-btn {
      width:40px;height:40px;background:#f4f4f5;border:none;border-radius:50%;
      display:flex;align-items:center;justify-content:center;cursor:pointer;
      font-size:20px;color:#6b7280;transition:all 0.25s ease;box-shadow:0 1px 3px rgba(0,0,0,0.1);
    }
    .logout-btn:hover {background:#fee2e2;color:#dc2626;transform:scale(1.1);}
    .logout-btn:active {transform:scale(0.95);}

    /* Rest of your styles (unchanged) */
    .chat-container {height:calc(100dvh - 60px);display:flex;flex-direction:column;background:#fff;}
    .chat-header {padding:16px;border-bottom:1px solid #e5e7eb;background:#fff;flex-shrink:0;}
    .chat-header h2 {font-size:18px;font-weight:600;color:#111827;margin-bottom:4px;}
    .chat-header p {font-size:13px;color:#6b7280;}
    .online-status {display:inline-flex;align-items:center;gap:5px;font-size:12px;color:#10b981;font-weight:500;}
    .online-dot {width:7px;height:7px;background:#10b981;border-radius:50%;animation:pulse 2s infinite;}
    @keyframes pulse {0%,100%{opacity:1} 50%{opacity:0.5}}

    #messages-list {flex:1;overflow-y:auto;padding:16px;background:#f9fafb;list-style:none;}
    #messages-list li {margin-bottom:16px;display:flex;animation:slideIn 0.3s ease;}
    @keyframes slideIn {from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)}}

    .message-wrapper {max-width:85%;display:flex;flex-direction:column;}
    .message-header {display:flex;align-items:center;gap:6px;margin-bottom:5px;}
    .message-sender {font-weight:600;font-size:12px;color:#374151;}
    .message-badge {background:#000;color:#fff;padding:2px 6px;border-radius:8px;font-size:9px;}
    .admin-badge {background:#10b981;}
    .message-content {padding:12px 14px;border-radius:14px;word-break:break-word;line-height:1.5;font-size:14px;}
    .message-time {font-size:10px;color:#9ca3af;margin-top:3px;}

    .own-message {justify-content:flex-end;}
    .own-message .message-wrapper {align-items:flex-end;}
    .own-message .message-content {background:#000;color:white;}

    .other-message {justify-content:flex-start;}
    .other-message .message-wrapper {align-items:flex-start;}
    .other-message .message-content {background:#fff;color:#111827;border:1px solid #e5e7eb;}

    #message-form {
      padding:12px 16px;padding-bottom:calc(12px + env(safe-area-inset-bottom));
      background:#fff;border-top:1px solid #e5e7eb;display:flex;gap:10px;flex-shrink:0;
    }
    #message-input {flex:1;padding:12px 16px;border:1px solid #d1d5db;border-radius:24px;
      font-size:14px;outline:none;background:#fff;min-height:44px;}
    #message-input:focus {border-color:#000;box-shadow:0 0 0 3px rgba(0,0,0,0.05);}
    #send-btn {background:#000;color:white;border:none;padding:12px 20px;border-radius:24px;
      font-weight:600;cursor:pointer;min-height:44px;}
    #send-btn:active {background:#1f2937;transform:scale(0.97);}

    #loading {position:fixed;top:0;left:0;width:100%;height:100%;background:#fff;
      display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:1000;}
    .spinner {width:40px;height:40px;border:3px solid #f3f4f6;border-top:3px solid #000;
      border-radius:50%;animation:spin 1s linear infinite;}
    @keyframes spin {to{transform:rotate(360deg)}}

    .empty-state {display:flex;flex-direction:column;align-items:center;justify-content:center;
      height:100%;text-align:center;padding:20px;color:#9ca3af;}
    .empty-icon {font-size:48px;margin-bottom:16px;opacity:0.4;}

    @media (min-width:768px) {
      .header {padding:15px 30px;height:70px;}
      .logo-icon,.user-avatar {width:40px;height:40px;font-size:18px;}
      .logout-btn {width:44px;height:44px;font-size:22px;}
      .chat-container {max-width:900px;margin:0 auto;}
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="config.js"></script>
</head>
<body>

  <div id="loading"><div class="spinner"></div><p>Loading...</p></div>

  <div id="main-content" style="display:none;">
    <div class="header">
      <div class="header-left">
        <div class="logo-icon">FZ</div>
        <div class="logo-text">FZ Network</div>
      </div>

      <div class="header-right">
        <div class="user-info">
          <div class="user-avatar" id="user-avatar"></div>
          <span class="user-name" id="user-name"></span>
        </div>

        <!-- Only Icon – No Text -->
        <button class="logout-btn" id="logout-btn" title="Log out">♻️</button>
      </div>
    </div>

    <div class="chat-container">
      <div class="chat-header">
        <h2>Support Chat</h2>
        <p><span class="online-status"><span class="online-dot"></span> Online</span> • Our team is ready to help you</p>
      </div>

      <ul id="messages-list">
        <div class="empty-state">
          <div class="empty-icon">Chat</div>
          <h3>Welcome!</h3>
          <p>Type your question or issue below</p>
        </div>
      </ul>

      <form id="message-form">
        <input id="message-input" placeholder="Type your message..." autocomplete="off" required />
        <button type="submit" id="send-btn">Send</button>
      </form>
    </div>
  </div>

  <script>
    let ADMIN_UID = null;
    let isFirstMessage = true;

    function fetchAdminId() {
      return database.ref('admitId').once('value').then(s => ADMIN_UID = s.val());
    }

    // Logout – only icon
    document.getElementById('logout-btn').addEventListener('click', () => {
      if (confirm('Are you sure you want to log out?')) {
        auth.signOut().then(() => location.href = 'login.html');
      }
    });

    auth.onAuthStateChanged(async user => {
      await fetchAdminId();
      if (!user) return location.href = "login.html";

      document.getElementById("loading").style.display = "none";
      document.getElementById("main-content").style.display = "block";

      const name = user.displayName || user.email.split("@")[0];
      document.getElementById("user-name").textContent = name;
      document.getElementById("user-avatar").textContent = name.charAt(0).toUpperCase();

      loadMessages(user.uid);
    });

    const messagesList = document.getElementById("messages-list");
    function loadMessages(uid) {
      database.ref("supportMessages").orderByChild("timestamp").on("child_added", s => {
        const msg = s.val();
        if (msg.uid === uid || (msg.uid === ADMIN_UID && msg.replyTo === uid)) {
          if (isFirstMessage) { messagesList.innerHTML = ''; isFirstMessage = false; }

          const li = document.createElement("li");
          li.className = msg.uid === uid ? "own-message" : "other-message";

          const sender = msg.name || msg.email.split("@")[0] || "User";
          const badge = msg.role === "admin" ? '<span class="message-badge admin-badge">Support Team</span>' : '';

          const time = new Date(msg.timestamp).toLocaleString('en-US', {
            hour:'2-digit', minute:'2-digit', day:'2-digit', month:'short'
          });

          li.innerHTML = `<div class="message-wrapper">
            <div class="message-header"><span class="message-sender">${escapeHtml(sender)}</span>${badge}</div>
            <div class="message-content">${escapeHtml(msg.message)}</div>
            <div class="message-time">${time}</div>
          </div>`;
          messagesList.appendChild(li);
          messagesList.scrollTop = messagesList.scrollHeight;
        }
      });
    }

    document.getElementById("message-form").onsubmit = e => {
      e.preventDefault();
      const text = document.getElementById("message-input").value.trim();
      if (!text) return;

      database.ref("supportMessages").push({
        uid: auth.currentUser.uid,
        name: auth.currentUser.displayName || auth.currentUser.email.split("@")[0],
        email: auth.currentUser.email,
        message: text,
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        role: "user",
        replyTo: ADMIN_UID
      });
      document.getElementById("message-input").value = "";
    };

    function escapeHtml(t){const d=document.createElement('div');d.textContent=t;return d.innerHTML;}

    new MutationObserver(() => messagesList.scrollTop = messagesList.scrollHeight)
      .observe(messagesList, {childList:true});

    document.getElementById("message-input").addEventListener('focus', function(){this.style.fontSize='16px';});
  </script>
</body>
</html>